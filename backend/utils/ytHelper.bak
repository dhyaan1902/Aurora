const ytdlp = require('yt-dlp-exec');

// Find YouTube video using ISRC (primary method)
async function findByISRC(isrc) {
    if (!isrc) return null;

    try {
        const result = await ytdlp(`ytsearch1:${isrc}`, {
            dumpSingleJson: true,
            noWarnings: true,
            skipDownload: true,
            flatPlaylist: true
        });

        // Handle both single result and playlist format
        const video = result.entries ? result.entries[0] : result;

        if (!video || !video.id) return null;

        return {
            videoId: video.id,
            url: `https://youtube.com/watch?v=${video.id}`,
            title: video.title,
            duration: video.duration,
            uploader: video.uploader
        };
    } catch (error) {
        console.log('ISRC search failed:', isrc, error.message);
        return null;
    }
}

// Fallback search method
async function fallbackSearch(trackName, artistName) {
    const queries = [
        `${trackName} ${artistName} topic`,
        `${trackName} ${artistName} official audio`,
        `${trackName} ${artistName}`
    ];

    for (const query of queries) {
        try {
            const result = await ytdlp(`ytsearch1:${query}`, {
                dumpSingleJson: true,
                noWarnings: true,
                skipDownload: true,
                flatPlaylist: true
            });

            // Handle both single result and playlist format
            const video = result.entries ? result.entries[0] : result;

            if (!video || !video.id) continue;

            return {
                videoId: video.id,
                url: `https://youtube.com/watch?v=${video.id}`,
                title: video.title,
                duration: video.duration,
                uploader: video.uploader
            };
        } catch (error) {
            console.log(`Search failed for: ${query}`);
            continue;
        }
    }

    return null;
}

// Get YouTube match for Spotify track
async function getYoutubeMatch(spotifyTrack) {
    const isrc = spotifyTrack.external_ids?.isrc;
    const spotifyDuration = spotifyTrack.duration_ms / 1000;

    console.log(`Track: ${spotifyTrack.name} by ${spotifyTrack.artists[0].name}`);
    console.log(`ISRC: ${isrc || 'not available'}`);
    console.log(`Duration: ${spotifyDuration}s`);

    // Try ISRC first
    if (isrc) {
        console.log(`Searching YouTube with ISRC: ${isrc}`);
        const match = await findByISRC(isrc);

        if (match) {
            const durationDiff = Math.abs(match.duration - spotifyDuration);
            console.log(`ISRC match found: ${match.title} (duration diff: ${durationDiff}s)`);

            if (durationDiff <= 10) {
                return {
                    ...match,
                    confidence: 'high',
                    method: 'isrc'
                };
            } else {
                console.log(`Duration mismatch too large, trying fallback...`);
            }
        }
    }

    // Fallback to search
    console.log(`Searching YouTube: ${spotifyTrack.name} ${spotifyTrack.artists[0].name}`);
    const match = await fallbackSearch(
        spotifyTrack.name,
        spotifyTrack.artists[0].name
    );

    if (match) {
        const durationDiff = Math.abs(match.duration - spotifyDuration);
        console.log(`Search match found: ${match.title} (duration diff: ${durationDiff}s)`);

        return {
            ...match,
            confidence: durationDiff <= 5 ? 'medium' : 'low',
            method: 'search'
        };
    }

    console.log('No match found!');
    return null;
}

// Get stream URL
async function getStreamUrl(videoId) {
    try {
        console.log(`Getting stream URL for video ID: ${videoId}`);

        const streamUrl = await ytdlp(`https://youtube.com/watch?v=${videoId}`, {
            format: 'bestaudio',
            getUrl: true,
            noWarnings: true
        });

        return streamUrl.trim();
    } catch (error) {
        console.error('Failed to get stream URL:', error.message);
        throw error;
    }
}

// Download track
async function downloadTrack(videoId, spotifyTrack) {
    const sanitizedTitle = spotifyTrack.name.replace(/[^a-z0-9]/gi, '_');
    const outputTemplate = `downloads/${sanitizedTitle}_${videoId}.%(ext)s`;

    try {
        console.log(`Downloading video ID: ${videoId}`);

        await ytdlp(`https://youtube.com/watch?v=${videoId}`, {
            extractAudio: true,
            audioFormat: 'mp3',
            output: outputTemplate,
            quiet: false
        });

        return `${sanitizedTitle}_${videoId}.mp3`;
    } catch (error) {
        console.error('Download failed:', error.message);
        throw error;
    }
}

module.exports = {
    getYoutubeMatch,
    getStreamUrl,
    downloadTrack
};